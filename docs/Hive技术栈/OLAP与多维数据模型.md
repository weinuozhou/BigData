# OLAP和多维数据模型

## OLAP概述

OLAP(OnLine Analytical Processing, 联机分析处理)是使用多维结构为分析提供对数据的快速访问的一种最新技术。OLAP的源数据通常存储在关系数据库的数据仓库，**OLAP的核心是多维数据分析**

**OLAP的特性**

* *多维性*:OLAP技术是面向主题的多维数据分析技术
* *可理解性或可分析性*:为OLAP分析设计的数据仓库或数据集市可以处理与应用程序和开发人员相关的任何业务逻辑和统计分析，同时使它对于目标用户而言足够简单
* *交互性*
* *快速性*:能够对查询提供一致的快速响应

OLAP为什么需要大量的聚集方体？
> 1. **提高查询性能**
    > - 通过预先计算并存储各种层次和维度的聚合数据，OLAP能够快速响应复杂的分析查询。这些聚集方体使得在执行多维分析时无需实时计算大量数据，从而显著提高查询效率
> 2. **多维数据分析**
    > - OLAP专为支持多维数据分析设计，聚集方体存储了不同维度（如时间、地区、产品等）和不同层级（如日、月、年）的汇总数据。这种多维结构使得用户能够从各个角度灵活地查看和分析数据
> 3. **满足复杂业务需求**
    > - 企业的业务分析需求通常很复杂，需要对数据进行各种切片、切块、钻取和旋转操作。预先建立的聚集方体可以满足这些复杂的分析需求，而无需对原始数据进行频繁的处理和计算
> 4. **支持快速决策制定**
    >  - 在商业环境中，快速的数据访问和分析是必需的。预聚集的方体确保了决策者能够实时获取所需的分析结果，以支持快速决策
>  5. **易于理解和使用**
    >  - 聚集方体将数据以直观的多维形式表示，使得非技术用户（如业务分析师和高级管理人员）也能容易地进行数据探索和分析

### 数据仓库与OLAP的关系

1. **数据仓库为OLAP提供数据源**： 数据仓库是OLAP的主要数据源之一。OLAP系统需要大量数据来支持多维分析，而数据仓库正是为了这个目的而创建的。数据仓库中的数据通常经过清洗、转换和整合，以确保数据的质量和一致性，这使得它们成为用于OLAP的理想数据源。
2. **OLAP增强数据仓库的分析能力**： 数据仓库中存储的数据通常以表格形式组织，这样可以更容易地进行存储和管理。然而，对于复杂的多维分析，表格结构并不足够。这就是OLAP发挥作用的地方。OLAP系统可以将数据以多维度方式组织，并提供强大的查询和分析功能，从而增强了数据仓库的分析能力。
3. **数据仓库和OLAP的协同作用**： 在许多组织中，数据仓库和OLAP系统紧密协同工作。数据仓库负责数据的存储和管理，OLAP系统则负责数据的分析和可视化。用户可以使用OLAP工具连接到数据仓库，通过多维度分析数据来支持决策制定。

## 多维数据模型的相关概念

多维数据模型将数据看成**数据立方体**的形式，满足用户从多角度多层次进行数据查询和分析的需要而建立起来的基于事实和维的数据库模型

<center><img src='https://cdn.jsdelivr.net/gh/weno861/image/img/202402052007289.png'></center>  

### 粒度

粒度是指多维数据集中数据的**详细程度和级别**。数据越详细，粒度越小级别也越低

### 维和维表

* 维是人们观察数据的特定角度，是考虑问题时的一类属性。此类属性的集合构成一个维度，如时间维、地理维等等
* 维表是指**存放维数据**的表，维表中的数据具有维层次结构，包含维属性和维成员

### 维属性和维成员

* 一个维是通过一组属性来描述的。表时间维中，对应的维属性是年份、季度、月份和日期
* 维的一个取值称为该维的一个维成员。如果一个维是多层次的，那么该维的维成员是在不同维层次的取值

### 维层次

* 人们从一个维的角度观察数据，还可以根据细节程度的不同形成多个描述层次，这个描述层次称为维层次
* 一个维往往有多个不同的层次

### 度量或事实

* 度量(Measure)是多维数据集中的信息单元，即多维空间中的一个单元，用以存放数据，也称为事实
* 通常是数值型数据并具有可加性

### 多维数据集

* 数据仓库和OLAP服务是基于多维数据模型的，这种模型将多维数据集看作数据方体(data cube)形式
* 多维数据集可以用一个多维数组来表示，它是维和度量列表的组合表示
* 一个多维数据集表示为:**(维1，维2，...，维 n, 度量列表)**

## OLAP基本分析操作

OLAP基本分析操作有切片、切块、旋转、上卷和下钻等等，它们就像SQL中的选择、投影和连接运算一样

<center><img src='https://cdn.jsdelivr.net/gh/weno861/image/img/202402052004352.png'></center>

### 切片

在多维数据集的某一维选定一个维成员的操作叫做切片

### 切块

在多维数据集中通过对两个或多个维执行选择得到子集的操作称为切块

### 旋转

旋转是一种视图操作，即改变一个报告或页面显示的维方向（交换行列、维的位置互换等等），可以得到不同视角的数据

### 上卷

上卷操作是通过维的概念分层向上攀升或者通过维规约在数据立方体上进行聚集

### 下钻

下钻是上卷的逆操作，它由不太详细的数据到更详细的数据，相当于沿维的概念分层向下或引入新的维或层次


### Hive的高阶聚合函数

使用`with cube`函数会将你的`group by`中所有列组合进行`group by`操作，相当于做$2^n$次`group by`

```hive
insert into cube_table
select * from table_name
group by a, b, c
with cube;
```

通过sql操作cube,我们就可直接得到特定a、c维度的度量值，不需要繁琐的group by操作

```hive
select * from cube_table
where a is not null and c is not null and b is null; //等价于group by (a, c)
```

* 切片操作:想要看到的维度设置成not null,其他维度设置成null
* 切块操作:与切片操作类似
* 上卷操作:只关注想要的维度，设置成not null
* 下钻操作:同上卷操作

`grouping sets`函数:自由指定想要的维度组合

```hive
insert into cube_table
select * from table_name
group by a, b, c
grouping sets((a, b), (a, c))
```

`with rollup`函数:按照`group by`的顺序做组合，而不是全组合

```hive
select * from cube_table
group by country, privince, city, district
with rollup
```

## 数据仓库与维度建模

### OLAP的分类

* **关系OLAP(ROLAP)**:以关系数据库为核心，以关系关系型结构进行多维数据的表示和存储
* **多维OLAP(MOLAP)**:以多维数据组织方式为核心，使用多维数组存储数据
* **混合OLAP(HOLAP)**:基于混合数据组织的OLAP实现
* Others

<center><img src='https://cdn.jsdelivr.net/gh/weno861/image/img/202402052009092.png'></center>

| 比较项 |                            ROLAP                             |                            MOLAP                             |
| :----: | :----------------------------------------------------------: | :----------------------------------------------------------: |
|  优点  | 没有存储大小的限制<br />现有的关系型数据库技术可以沿用<br />对维度的动态变更有很好的适应性<br />灵活性较好，数据变化适应性高<br />对软硬件平台适应性较好 | 性能好、响应速度快<br />专为OLAP设计<br />支持高性能的决策支持计算<br />支持复杂的跨维计算<br />支持行级计算 |
|  缺点  | 一般比MOLAP响应慢<br />系统不提供预综合处理功能<br />关系SQL无法完成部分计算<br />无法完成多行的计算<br />无法完成维之间的计算 | 增加系统培训和维护费用<br />受操作系统中文件大小的限制<br />系统所进行的预计算，可能导致数据爆炸<br />无法支持数据及维度的动态变化<br />缺乏数据模型和数据访问之间的额标准 |

### 数据仓库建模方法分类

#### ROLAP系统建模方法

* ROLAP是一种基于关系型数据库的OLAP系统，数据存储在关系型数据库中，分析时直接从数据库中读取数据进行计算和分析
* ROLAP系统建模方法通常采用**维度建模**

##### 维度建模

* 维度建模将数据分为维度表和事实表，维度表用于对事实表进行分类和聚合，从而实现多维分析
* 根据**事实表和维度表的关系**，常见的模型可分为星形模型、雪花模型和事实星座模型

###### 星形模型

星形模型是最常用的数据仓库设计结构的实现模式，它由**一个事实表和一组维表**组成，该模型的核心是**事实表**,事实表的主键是维表的外键，各个维表都连接到中央事实表，事实表的非主属性便是事实

<center><img src='https://cdn.jsdelivr.net/gh/weno861/image/img/202402052014142.png'></center>

**星形模型的特点**

* 维度表只与事实表关联，维度表彼此之间没有任何联系
* 每个维度表的主键只能是单列的，同时该主键被放置在事实表中，用做事实表和维表连接的外键
* 星形模型以事实表为核心，其他维表围绕这个核心呈现星形分布

###### 雪花模型

雪花模型是对星形模型的扩展，每一个维表都可以向外连接多个详细类别表，雪花模型的维表存储了规范化的数据，这种结构通过把多个较小的规范化表联合在一起来改善查询性能，由于采取了规范化及维的低粒度，雪花模型提高了数据仓库应用的灵活性

<center><img src='https://cdn.jsdelivr.net/gh/weno861/image/img/202402052014967.png'></center>

**雪花模型的特点**

* 某个维表不与事实表直接关联，而是与另一个维表关联
* 可以进一步细化查看数据的粒度
* 维表与其相关联的其他维表也是通过外键相关联
* 雪花模型以事实数据表为核心

**星形模型和雪花模型的区别**

* 雪花模型的维表可能是规范化的形式，以便于减少了冗余，这种表易于维护并节省存储空间
* 由于执行查询需要更多的连接操作，雪花模型可能降低浏览的性能
* 雪花模型减少了冗余，但在数据仓库设计中，雪花模型不如星形模型流行

###### 事实星座模型

在一个多主题的复杂数据仓库中可能存放多个事实表，此时就会出现**多个事实表**共享一个或者多个维表的情况

<center><img src='https://cdn.jsdelivr.net/gh/weno861/image/img/202402052016359.png'></center>

**事实星座模型的特点**

1. **多个事实表**：
   - 与传统的星型模型不同，事实星座模型包含多个事实表。
   - 这些事实表通常是根据业务过程独立建立的，每个表都可以表示不同的业务测量维度。

2. **共享维度表**：
   - 多个事实表可能共享相同的维度表。
   - 这种共享机制有助于保持数据一致性，同时减少数据冗余。

3. **复杂性较高**：
   - 由于涉及多个事实表和维度表的共享，这种模型的结构比单一的星型模型复杂。
   - 这种复杂性可能导致查询的设计和执行更加复杂。

4. **灵活性和可扩展性**：
   - 事实星座模型由于其多事实表的特性，对于复杂业务环境下的数据分析和报告提供了更高的灵活性。
   - 它能更好地适应业务的变化和扩展。

5. **适用于复杂业务规则**：
   - 当业务规则复杂且业务过程之间存在关联时，事实星座模型能更有效地表示这些复杂关系。

6. **性能考虑**：
   - 由于其复杂性，事实星座模型在性能上可能不如更简单的模型。
   - 在实施时需要仔细考虑查询的优化和数据仓库的性能