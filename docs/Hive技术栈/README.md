# 数据仓库基础

<center><img src='https://cdn.jsdelivr.net/gh/weno861/image/img/202402051711263.png'></center>

##  数据仓库概述

* 数据仓库是一个用于存储、分析、报告的数据系统
* 数据仓库的目的是构建面向分析的集成化数据环境，分析结果为企业提供决策支持

### 数据仓库为何而来

> 为了分析数据而来，分析结果给企业决策提供支撑

企业相关信息的目的:

* **操作型记录的保存**

  * 联机事务处理系统（OLTP）可以满足该业务需求的展开
  * 关系型数据库是OLTP的典型应用
  <center><img src='https://cdn.jsdelivr.net/gh/weno861/image/img/202402051713825.png'></center>

* **分析型决策的制定**

  * **基于业务数据开展数据分析，基于分析的结果给决策提供支撑**，数据驱动决策的制定

  > **OLTP环境下开展分析可行吗？**
  >
  > * 可行，但没必要。OLTP系统的核心是面向业务，支持业务，支持事务。所有的业务操作可以分为读、写两种操作，一般来说读的压力明显大于写的压力。如果在OLTP 环境直接开展各种分析，有以下问题需要考虑：
  >
  >   * 数据分析也是对数据进行读取操作，会让读取压力倍增；
  >
  >   * OLTP仅存储数周或数月的数据；
  >
  >   * 数据分散在不同系统不同表中，字段类型属性不统一
  >
  > * 当分析所涉及数据规模较小的时候，在业务低峰期时可以在OLTP 系统上开展直接分析。但是为了更好的进行各种规模的数据分析，同时也不影响OLTP 系统运行，此时需要构建一个集成统一的数据分析平台

### 数据仓库的概念

数据仓库是一个用于存储、分析、报告的数据系统，**目的是构建面向分析的集成化数据环境**。我们把这种**面向分析**、**支持分析的系统**称之为OLAP(联机分析处理)系统

<center><img src='https://cdn.jsdelivr.net/gh/weno861/image/img/202402051714852.png'></center>

### 数据仓库的特征

* **面向主题**:主题是一个抽象的概念，是较高层次上企业信息系统中的数据综合、归类并进行分析利用的抽象
* **集成的**: 主题相关的数据通常会分布在多个操作型系统中，彼此分散、独立、异构(数据孤岛),因此需要统一源数据
* **稳定性而非易失性**:数据的相对稳定性，数据仓库中的数据只进行新增，没有更新操作、删除操作处理
* **随时间变化的即时变性**:数据仓库大多关注的是历史数据，其中数据是批量载入的，即定期从操作型应用系统中接收新的数据内容，这使得数据仓库中的数据总是拥有时间维度
* 数据仓库的稳定性和时变性并不矛盾，从大时间段来看，它是时变的；但从小时间段来看，它是稳定的；数据仓库还具有**高效率、高数据质量、扩展性好和安全性好**等特点

<center><img src='https://cdn.jsdelivr.net/gh/weno861/image/img/202402051714100.png'></center>

### 数据库与数据仓库的区别

* 数据库和数据仓库的主要区别在于它们的**设计目的**、**数据存储方式**和**数据使用场景**。
* 数据库通常用于存储**实时的、事务性**的数据，是**联机事务处理**（OLTP）系统的核心，设计重点是保证数据的一致性、实时性和快速响应。
* 数据仓库则是为了**分析和报告**而设计的，它存储的是历史数据，用于**联机分析处理**（OLAP）。数据仓库优化了大量数据的查询和数据挖掘操作，通常具有大规模的数据集成和时间序列的数据

## OLAP、OLTP的简介

### OLTP

* 操作型处理，叫联机事务处理OLTP(On-Line Transaction Processing)，主要目标是做数据处理，它是针对具体业务在数据库联机的日常操作，通常对少数记录进行查询、修改
* 用户较为关心操作的响应时间、数据的安全性、完整性和并发支持的用户数等问题
* 传统的关系型数据库系统(RDBMS)作为数据管理的主要手段，主要用于操作型处理

### OLAP

* 分析型处理,主要用于历史数据分析,这类数据库作为公司的单独数据存储，负责利用历史数据对公司各主题域进行统计分析
* 一条语句的执行时间可能会非常长,读取的数据也非常多。所以,在这样的系统中,考核的标准往往是磁盘子系统的吞吐量(带宽),如能达到多少MB/s 的流量,强调磁盘I/O,强调分区等
* 数据仓库是OLAP的一个典型示例

## 数据仓库系统中的组成及重要基础理论

### 数据源

数据的来源称为数据仓库的数据源，数据源并不局限于传统数据库，也可以是非结构化的数据，如**爬取日志**和**埋点日志**

> * 非结构化数据的概念:非结构化数据指数据定义不完整或不规则，没有预定义的数据模型，**无法用数据库二维表结构来逻辑表达的数据**，常见的非结构化数据包括文档、图片、音频和视频等等
> * 非结构化数据的查询
>   * 顺序扫描法
>     * 比如要找内容包含某一个字符串的文件，就是一个文档一个文档的看，对于每一个文档，从头看到尾，如果此文档包含此字符串，则此文档为我们要找的文件，接着看下一个文件，直到扫描完所有的文件。如利用windows 的搜索也可以搜索文件内容，只是相当的慢
>   * 全文检索
>     * 全文检索将非结构化数据中的一部分信息提取出来重新组织，使其变得有一定结构，然后对此有一定结构的数据进行搜索，从而达到搜索相对较快的目的。**这部分从非结构化数据中提取出的然后重新组织的信息，我们称之索引**
> * 非结构化数据的存储
>   * 将非结构化数据以文件的方式存储在文件系统中，同时将指向文件的链接或路径存储在数据库表中。这种方式数据读写的速度较快，但数据管理不方便，并需要额外考虑事务处理的一致性和数据的安全性
>   * 将非结构化数据存储在传统的数据库表的大对象字段中。这种方式充分利用数据库的事务、管理和安全特性，但在数据查询和读写的性能不高。 为解决上面两种方式的缺点，利用其所长，**最新的非结构化数据存储技术在磁盘格式、网络协议、空间管理、重做和撤销格式、缓冲区缓存以及智能的I/O 子系统等方面发生重大转变，在保证了文件数据的性能的同时，还保留了数据库的优势。较有代表性的就是Oracle SecureFiles 非结构化数据存储方式**
> * 爬取日志和埋点日志的概念
>   * 爬取日志:利用`Python`爬虫等技术，能够在数分钟内，实现自动登录QQ 空间，抓取个人信息、好友列表、说说和日志等信息，同时能够及时对抓取的数据进行加密，保证了通信安全
>   * 埋点日志:就是在业务系统的程序中，植入一些收集事件数据的`SDK`(工具代码)，进行各种事件的收集；是数据仓库主要的数据来源
>     * 埋点代码可以植入到业务系统的后端程序中（比如java 、php 等）也可以植入到业务系统的前端程序（原生app 、页面js 、微信小程序）中 
>     * 埋点日志数据说明埋点会生成统一格式的数据文件,JSON 格式各个终端渠道的埋点日志，都由公共属性字段，和事件属性字段组成；不同终端渠道，公共属性字段略有不同；事件属性则根据事件类型，灵活多样；

### 抽取工具:ETL（Extract、TRansform、Load）

* ETL 是将业务系统中的数据经过**抽取（Extract）、清洗转换（Transform）和加载（Load）**到数据仓库的过程，目的是将企业中的分散、凌乱、标准不统一的数据整合到一起，为企业的决策提供分析依据。
* ETL处理分为五大模块，分别是：**数据抽取、数据清洗、数据转换、规则检查、数据装载**。各模块之间灵活组合，形成ETL 处理流程

#### 数据抽取

对于数据的抽取，是从各个不同的数据源抽取到ODS(Operational Data Store，操作型数据存储)中

**具体步骤为:首先要搞清楚数据是从哪几个业务系统中来，各个业务系统的数据库服务器运行什么DBMS，是否存在非结构化的数据等，当收集完这些信息后才可以进行数据抽取的设计**

* 对于与存放于 DW 的数据库系统相同的数据源处理方法
  * 这类数据源在设计上比较容易处理。一般情况下，DBMSDBMS（Mysql 、SQLServer）都会提供数据库连接功能，在 DW 数据库服务器和原业务系统之间建立直接的连接关系，接下来就可以写查询语句直接访问
* 对于与存放于 DW 的数据库系统不同的数据源处理方法
  * 对于这类数据源，一般情况下也可以通过 ODBC( Open Database Connectivity 开放数据库互连)，的方式建立数据库连接。如果不能建立数据库连接，可以用两种方法完成，一种是通过工具将数据源导出成 .txt 或者 xls 文件，然后再将这些源系统文件导入到 ODS 中。另一种方法是通过程序接口来完成
* 对于文件类型数据源
  * 业务人员可以利用数据库工具将这些数据导入到指定的数据库，然后从指定的数据库中抽取。或者业务人员借助工具实现
* 增量更新问题
  * 对于数据量大的系统，必须考虑增量抽取。一般情况，业务系统会记录业务发生的时间，可以用作增量的标志，每次抽取之前首先判断 ODS 中记录最大的时间，然后根据这个时间去业务系统取大于这个时间的所有记录

**ODS的概念**

ODS（Operational Data Store）操作性数据，是作为数据库到数据仓库的一种过渡，ODS的数据结构一般与数据来源保持一致，便于减少ETL 的工作复杂性，而且ODS的数据周期一般比较短。ODS的数据最终流入DW 

* ODS是一个面向主题的、集成的、可变的、当前的细节数据集合，用于支持企业对于即时性的、操作性的、集成的全体信息的需求。常常被作为数据仓库的过渡，也是数据仓库项目的可选项之一
* ODS 和DW 的区别主要体现数据的可变性、当前性、稳定性、汇总度上。ODS中的数据也尽量不做转换，而是原封不动地与业务数据库保持一致。即ODS 只是业务数据库的一个备份或者映像，目的是为了使数据仓库的处理和决策支持要求与OLTP 系统相隔离，减少决策支持要求对OLTP系统的影响

**ODS的特征**

1. ODS直接存放从业务抽取过来的数据，这些数据从结构和数据上与业务系统保持一致，降低了数据抽取的复杂性
2. 转移一部分业务系统的细节查询功能，因为ODS存放的数据与业务系统相同，原来有业务系统产生的报表，现在可以从ODS中产生
3. 完成数据仓库中不能完成的功能，ODS存放的是明细数据，数据仓库DW或数据集市DM都存放的是汇聚数据，ODS提供查询明细的功能
4. ODS数据只能增加不能修改，而且数据都是业务系统原样拷贝，所以可能存在数据冲突的可能，解决办法是为每一条数据增加一个时间版本来区分相同的数据

**ODS的作用**

1. **在业务系统和数据仓库之间形成一个隔离层**，一般的数据仓库应用系统都具有非常复杂的数据来源，这些数据存放在不同的地理位置、不同的数据库、不同的应用之中，从这些业务系统对数据进行抽取并不是一件容易的事。因此，ODS 用于存放从业务系统直接抽取出来的数据，这些数据从数据结构、数据之间的逻辑关系上都与业务系统基本保持一致，因此在抽取过程中极大降低了数据转化的复杂性，而主要关注数据抽取的接口、数据量大小、抽取方式等方面的问题
2. **转移一部分业务系统细节查询的功能**，在数据仓库建立之前，大量的报表、分析是由业务系统直接支持的，在一些比较复杂的报表生成过程中，对业务系统的运行产生相当大的压力。ODS 的数据从粒度、组织方式等各个方面都保持了与业务系统的一致，那么原来由业务系统产生的报表、细节数据的查询自然能够从ODS 中进行，从而降低业务系统的查询压力
3. **完成数据仓库中不能完成的一些功能**，一般来说，带有ODS 的数据仓库体系结构中，DW 层所存储的数据都是进行汇总过的数据和运营指标，并不存储每笔交易产生的细节数据，但是在某些特殊的应用中，可能需要对交易细节数据进行查询，这时就需要把细节数据查询的功能转移到ODS 来完成，而且ODS 的数据模型按照面向主题的方式进行存储，可以方便地支持多维分析等查询功能。即数据仓库从宏观角度满足企业的决策支持要求，而ODS 层则从微观角度反映细节交易数据或者低粒度的数据查询要求

#### 数据清洗

一般情况下，数据仓库分为ODS 、DW 两部分。做法是从业务系统到ODS 做清洗，将脏数据和不完整数据过滤掉，再从ODS 到DW 的过程中转换，进行一些业务规则的计算和聚合

脏数据（Dirty Read Read）是指源系统中的数据不在给定的范围内或对于实际业务毫无意义，或是数据格式非法，以及在源系统中存在不规范的编码和含糊的业务逻辑

**缺省值**
> * 产生的原因可能是，信息暂时无法获取、信息被遗漏、属性值不存在，比如一个儿童的固定收入等
> * 解决方法是:通过简单的统计分析，得到含有缺失值的属性个数，以及每个属性的未缺失数、缺失数和缺失率。删除含有缺失值的记录、对可能值进行插补和不处理三种情况

 **异常值**
> * 产生的原因可能是：业务系统检查不充分
> * 解决方法是:先对变量做一个描述性统计，进而查看哪些数据是不合理的。最常用的统计量是最大值和最小值，然后判断变量是否超过了合理的范围
>   * 如果数据是符合正态分布，在原则下，异常值被定义为一组测定值中与平均值的偏差超过3倍标准差的值，如果不符合正态分布，也可以用原理平均值的多少倍标准差来描述

#### 数据转换

数据转换的任务主要是**进行不一致数据(结构、格式)转换**、**数据粒度的转换**、**以及一些商务规则的计算**

* *不一致的数据转换*
    * 这个过程是一个整合的过程，将不同业务系统的相同类型的数据统一，比如同一个用户在用户管理系统的编码是 XX0001 ，而在订单系统的编码是 YY0001 ，这样在抽取过来之后统一转换成一个编码
* *数据粒度的转换*
    * 业务系统一般存储粒度较小的数据，而数据仓库中的数据是用来分析的，不需要粒度很小的数据，一般情况下，会将业务系统数据按照数据仓库粒度进行聚合
* *商务规则的计算*
    * 不同的企业有不同的业务规则，不同的数据指标，这些指标有时候不能简单的加加减减就能完成，这个时候需要在 ETL 中将这些数据指标计算好了之后存储在数据仓库中，供分析使用

#### 规则检查

规则检查在ETL中扮演着关键角色，主要包括以下几个方面的工作：

1. **数据验证和一致性检查**：
   - 在数据处理和数据仓库系统中，规则检查用于验证数据的准确性和一致性。它确保数据满足预定义的标准和格式，例如检查日期格式、数值范围、字符串模式等。

2. **业务规则执行**：
   - 在业务流程管理中，规则检查确保所有操作都符合组织的业务规则。这包括审批流程、事务处理规则、客户服务标准等。

3. **安全合规性**：
   - 规则检查是确认系统和数据符合安全政策和法规要求的重要手段，例如检查访问控制、数据加密、日志记录等。


#### 数据装载

数据装载将转换和加工后的数据装载到目的库中通常是ETL过程的最后步骤。装载数据的最佳方法取决于所执行操作的类型以及需要装入多少数据，一般来说有两种装载方式:

* 直接SQL 语句进行insert 、update 、delete 操作
* 采用批量装载方法，sqlldr 等

> 大多数情况下使用第一种方法，因为它们进行了日志记录并且是可恢复的。但是，批量装载操作易于使用，并且在装入大量数据时效率较高。使用哪种数据装载方法取决于业务系统的需要

### 数据集市

数据集市（Data Market Market，DM）是为企业特定部门的决策支持而组织起来的一批数据和业务规划。它是一种小型的、部门级数据仓库。习惯上称之为 “主题域” ，企业的不同部门有不同的 “主题域” ，因而就有不同的数据集市

数据集市的种类主要有**独立型数据集市**和**从属型数据集市**

数据划分成集市之后，在进行某个确定主题的分析时，可以有效缩小数据的检索范围，明显提高工作效率

#### 独立型数据集市

**为了满足企业内各部门的分析需求而建立的微型数据仓库**

<center><img src='https://cdn.jsdelivr.net/gh/weno861/image/img/202402051944005.png'></center>

#### 从属型数据集市

从属型数据集市的内容并不直接来自外部数据源，而是从数据仓库中得到。在数据仓库内部，数据根据分析主题，划分成若干个子集，进行组织、存放。这种面向某个具体的主题而在逻辑上或物理上进行划分所形成的数据子集，就是从属型数据集市

<center><img src='https://cdn.jsdelivr.net/gh/weno861/image/img/202402051946108.png'></center>

### 元数据及其管理

元数据（Metadata）是关于**数据的数据**，在数据仓库中元数据位于数据仓库的上层，是描述数据仓库内数据的结构、位置和建立方法的数据，又称中介数据、中继数据，它描述了数据本身（如数据库、数据元素、数据模型）、数据表示的概念（如业务流程、应用系统、软件代码、技术基础设施）和数据与概念之间的联系

#### 元数据的分类

按其描述对象的不同可以划分为三类元数据：**业务元数据、技术元数据和操作元数据**

* *业务元数据*:业务元数据包括主题域、概念、实体、属性的非技术名称和定义、属性的数据类型和其他特征，如范围描述、计算公式、算法和业务规则、有效的域值及其定义
* *技术元数据*:技术元数据主要是描述系统中技术领域的相关概念信息，包括数据结构、数据处理方面的特征描述，以及数据源接口、数据仓库、数据集市、存储等全面数据处理环节的信息
* *操作元数据*:操作元数据主要是指与元数据管理相关的组织、岗位、职责、流程，以及系统日常运行产生的操作数据。

#### 元数据的作用

1. **描述和标识数据**：
   - 元数据提供了关于数据内容的描述，如数据的来源、格式、创建日期和作者等信息。这有助于用户理解数据的背景和上下文。

2. **提高数据检索效率**：
   - 通过对数据进行分类和标记，元数据使得数据的搜索和检索更加高效。它允许用户根据特定的属性或关键词快速找到所需信息。

3. **数据管理**：
   - 在数据仓库和数据库管理系统中，元数据用于跟踪数据的流动和处理过程，有助于数据的整理、存储和维护。

4. **支持数据分析和决策制定**：
   - 元数据提供了数据集的详细信息，辅助分析师更好地理解数据，从而做出更准确的分析和决策。

5. **确保数据一致性和质量**：
   - 元数据可以用于确保数据的一致性和准确性，通过记录数据的修改历史和版本控制来维护数据质量。

6. **遵循合规性和法规要求**：
   - 在许多行业中，元数据用于确保数据处理和存储符合特定的合规性和法律要求，如隐私保护、数据安全等。

7. **资源整合和共享**：
   - 元数据有助于不同系统和组织之间的数据集成和共享，它提供了数据交换的必要信息，确保数据能够被正确地理解和使用。

8. **版权和知识产权管理**：
   - 在数字媒体领域，元数据用于记录版权信息，帮助维护和管理知识产权。

#### 元数据的管理

元数据管理的内容主要包括以下方面:

* **获取并存储元数据**
* **元数据的集成**
* **元数据标准化**
* **保持元数据的同步**

> * 对于较简单的环境，按照通用的元数据管理标准建立一个集中式的元数据知识库
> * 对于比较复杂的环境，分别建立各部分的元数据管理系统，形成分布式元数据知识库

> 元数据模型不仅可以描述一个数据元，还可以对非结构化的文本进行结构化的表达。这里体现了元数据是一种数据建模方法，表达了数据组织和数据层次，值得特别关注。典型的例子就是图书馆检索系统对一个图书（非结构化文本）所建立的元数据模型，比如：元数据是“图书目录”。图书馆中的图书目录包含图书名称、编号、作者、位置等信息，有了它，图书管理员就能快速查找图书。元数据能够帮助数据管理员管理数据。后来这个方法也逐渐发展成为一般信息资源目录体系的描述方法，其核心元数据如下图所示。核心元数据说明元数据建模是有技巧的：它是有重点取舍的，可以衍生的，有特定维度的，体现了数字化表达的凝聚性特点

<center><img src='https://cdn.jsdelivr.net/gh/weno861/image/img/202402051951514.png'></center>

## **数据地图**

*数据地图*是一种图形化的数据资产管理工具，它提供了多层次的图形化展示，并 满足业务使用、数据管理、开发运维不同应用场景的图形查询和辅助分析需求

### 为什么有数据地图

1.  **提高数据可见性和可理解性**
    - 数据地图提供了组织内所有数据资产的概览，包括它们的来源、存储位置、格式和用途。这有助于用户更好地理解和定位数据
2. **促进数据治理**
    - 它是数据治理的关键组成部分，帮助确保数据的质量、一致性和合规性。通过数据地图，组织可以更容易地监控和管理数据的生命周期
3. **支持数据集成和数据共享**：
    - 在多个部门和系统之间共享数据时，数据地图提供了必要的信息，如数据的格式、接口和依赖关系，有助于数据的有效集成
4. **简化数据分析和报告**：
    - 对于数据分析师和业务用户来说，数据地图提供了关于数据位置和特性的关键信息，有助于简化数据查询和报告的过程
5. **协助风险管理和合规遵从**：
    - 数据地图帮助组织识别和管理数据相关的风险，如敏感数据的存储和访问控制，以及满足各种法律和合规要求
6. **优化数据架构和基础设施**：
    - 通过对现有数据资产的清晰了解，组织可以更有效地规划和优化其数据架构和基础设施
7. **提升数据的价值**：
    - 数据地图有助于识别数据资产的潜在价值，支持数据驱动的决策制定和创新

## 数据中台

数据中台是一种企业级的数据管理和服务架构，旨在统一组织内部的数据处理和分析。它的核心目标是为企业的各个业务线提供高效、可靠且一致的数据服务。数据中台的主要特点和功能包括：

1. **数据集成**：
   - 数据中台集成来自企业内部各个系统和部门的数据，包括ERP、CRM、财务系统等，实现数据的统一接入和处理
2. **数据治理**：
   - 它提供了一套完整的数据治理机制，包括数据质量管理、数据标准制定、数据安全和合规性管理
3. **数据服务化**：
   - 数据中台将数据转化为可重用的服务，使得业务部门能够便捷地获取和使用数据，而无需关心数据的来源和处理过程
4. **支持数据驱动的决策**：
   - 它为企业提供了一个统一的数据视图，有助于更好地进行数据分析和洞察，从而支持数据驱动的决策制定
5. **技术和平台独立性**：
   - 数据中台通常与特定的技术平台和工具无关，它通过抽象化的方式提供服务，使得企业能够灵活选择技术解决方案
6. **促进业务创新和敏捷性**：
   - 通过提供快速、灵活的数据服务，数据中台能够加速新产品的开发和市场响应，提高企业的竞云力和敏捷性
7. **降低数据管理成本**：
   - 统一的数据管理减少了数据冗余和不一致性，降低了数据存储和维护的成本

